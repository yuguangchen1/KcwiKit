# Running the DRP for the red channel

Here summarizes the typical routine with optional improvements to reduce the blue-channel KCWI data using the [updated DRP](../docs/install_DRP.md).

**Before you start**: Running the default DRP does not require to follow this instruction. Simply run ```reduce_kcwi -b -f kb*.fits -g```. 

1. Copy the [configuration file `kcwi.cfg`](../pyDRP/configs/kcwi.cfg) to the working directory. Adjust the parameters if needed. For example, we recommend to prioritize dome flat.

    Running the DRP until after `intf.fits`.

    ```bash
    reduce_kcwi -r -f kr*.fits -g -c kcwi.cfg -st ff
    ```

2. (Optional) Run the custom cosmic ray rejection. 

    Make a machine-readable log file.
    ```bash
    kcwi_gen_log <night>.log -f kr*.fits
    ```

    Automatically group the frames for median rejection. 
    ```bash
    kcrm_group_frames <night>.log kcrm_<night>.json -c -d -i
    ```

    Edit the `kcrm_<night>.json`, remove or correct the grouping. Typically, one needs to remove the standard stars in the `json` file, regroup the frames if necessary. 

    Run the cosmic-ray rejection code. 
    ```bash
    kcrm_create_crmsk kcrm_<night>.json
    ```
    This creates `*crmsk.fits` for each frame as cosmic-ray masks. Remove all the science frames in the `kcwir.proc` table. For example, for ```kr240211_00089``` frame, remove the following lines. 
    **Note: If you are dealing with bright point-like target (e.g. QSOs) it is highly recommended to inspect the generated _crmsk files to avoid false positives from QSO continuum/broad line**
    If you did get false positives, open the crmsk with ds9, create regions covering the false positives, and name it as, e.g., kr240902_00158_crmsk_recover.reg. The KcwiKit version DRP should identify the region and remove it from CR mask.

    This creates `*crmsk.fits` for each frame as cosmic-ray masks. 
    <details>
    <summary>(tips) Recover masked pixels </summary>

    For bright continuum or emission line objects, the cosmic-ray rejection method may mistakenly identify those as cosmic rays. A quickest fix is to
    specify the number of sigmas in sigma clipping. 
    ```bash
    kcrm_create_crmsk kcrm_<night>.json -s <sigma>
    ```
    The default is `3`. If this failed, you can recover some pixels manually by setting up a `region` file with a file name of `kr<date>_<frame>_crmask_recover.reg`. 
    The regions files will be automatically identified and the pixels inside the regions will be recovered.
    </details>
    
    Remove all the science frames in the `kcwib.proc` table. For example, for ```kr240211_00089``` frame, remove the following lines. 

    ```
    |      89 | 65c6d022d14508b9bd6870ea | 2201009 |   OBJECT |  2024-02-11-89 |   15.0 | RED | Medium |   RL |   28.52 |  4499.90 | 2,2 | KBlue |    60351.382006 |     5 |  intf | kb240211_00089.fits |      sdss08579 | kr240211_00089.fits |
    ```

    Rerun the DRP to the end of cube creation. 
    ```bash
    reduce_kcwi -r -f kr*.fits -g -c kcwi.cfg -st 2
    ```

4. (opitonal) Running the median filtering.
   **Note: This is not an optional step if you are dealing with bright point-like target due to the diffraction spikes** 

    Create white-light and 2D-flattened images for `icube.fits` files. 

    ```bash
    kcwi_collapse kr*_icube.fits
    kcwi_flatten_cube kr*_icube.fits
    ```

    Create region masks on the 2D-flattened images and white-light images. See [here](../docs/reg_construction.md) for instructions. 

    Run median filtering. 
    ```bash
    kcwi_medfilter kr*_icube.fits
    ```
    See [kcwi_medfilter](../docs/scripts_instruction.md) instructions for details to run and configure the parameters. 

5. Once again remove all the science entries in `kcwir.proc`. Run the DRP to the end. 

    ```bash
    reduce_kcwi -r -f kr*.fits -g -c kcwi.cfg -st 3
    ```

    If you would like to follow the telluric and PCA sky subtraction instructions below, it is not important to conduct the flux calibrations accurately.  

6. (optional) Telluric correction using [KCWI Sky Wizard](https://github.com/zhuyunz/KSkyWizard)

    `KSkyWizard` is a separate tool for telluric correction and sky subtraction for the red channel. For more information, follow the [flux calibration and telluric correction](https://github.com/zhuyunz/KSkyWizard?tab=readme-ov-file#3-flux-calibration-and-telluric-correction) part of the instruction. 

7. (optional) Improving the flux-calibration accuracy by combining multiple standard star frames. 

    This can be done on either the DRP generated flux calibrations or the telluric corrected flux calibrations. If you skipped the telluric correction, follow the [blue-channel instruction](./Running_blue_DRP.md) from step 6 to the end. 

    For the `invsens` files generated by `KSkyWizard`, create a list file similarly that contains the full paths of the `*_invsens_updated.fits` frames. Run `kcwi_combinestd <name>.list`. This will generate a combined `<name>_invsens_update.fits` file, and a figure with individual telluric and sky extinction models. Remove the outliers if you wish, and rerun `kcwi_combinestd`. The new combined `<name>_invsens_update.fits` can be loaded in `KSkyWizard` by clicking on `Open Updated Invsens` button in the `invsens` panel. Load this new combined `invsens` file before proceeding to the next step. 

8. (Optional) Conducting telluric correction and PCA sky subtraction using `KSkyWizard`.
    
    Follow the [sky subtraciton](https://github.com/zhuyunz/KSkyWizard?tab=readme-ov-file#4-sky-subtractionn) section of the `KSkyWizard` instruction. 

Now, you can continue to the [instruction on performing post-DRP stacking](./KCWI_post-DRP_stacking.md) to combine your frames. 







